<script>
   // Global variables
   let isJumping = false; // Prevent multiple jumps
   let keyState = {}; // Track pressed keys
   let characterSpeed = 3; // Movement speed for smooth transitions
   let jumpHeight = 130; // Max height for the jump
   let gravity = 5; // Gravity effect during jump
   let isFalling = false;

   // Track key presses
   window.addEventListener("keydown", (e) => {
      keyState[e.key] = true;
      if (e.key === "w" && !isJumping) {
         myJump();
      }
   });

   window.addEventListener("keyup", (e) => {
      keyState[e.key] = false;
   });

   // Main game loop
   function gameLoop() {
      const myImg = document.getElementById("myImg01");

      // Ensure `style.left` and `style.top` have valid initial values
      if (!myImg.style.left) myImg.style.left = "50px";
      if (!myImg.style.top) myImg.style.top = "200px";

      // Handle horizontal movement
      if (keyState["d"]) {
         setCharacter("Right");
         myImg.style.left = parseInt(myImg.style.left) + characterSpeed + "px";
      }
      if (keyState["a"]) {
         setCharacter("Left");
         myImg.style.left = parseInt(myImg.style.left) - characterSpeed + "px";
      }

      // Check collisions
      myCheckHit();
      myCheckWin();

      // Keep the loop running
      requestAnimationFrame(gameLoop);
   }

   // Update the character's sprite
   function setCharacter(action) {
      const myImg = document.getElementById("myImg01");
      myImg.src = `MainCharacter${action}.png`;
   }

   // Jump function
   function myJump() {
      isJumping = true;
      isFalling = false;
      const myImg = document.getElementById("myImg01");
      const startPos = parseInt(myImg.style.top);
      let currentHeight = 0;

      function jumpUp() {
         if (currentHeight < jumpHeight && !isFalling) {
            currentHeight += gravity;
            myImg.style.top = startPos - currentHeight + "px";
            requestAnimationFrame(jumpUp);
         } else {
            isFalling = true;
            jumpDown();
         }
      }

      function jumpDown() {
         if (currentHeight > 0) {
            currentHeight -= gravity;
            myImg.style.top = startPos - currentHeight + "px";
            requestAnimationFrame(jumpDown);
         } else {
            isJumping = false;
            setCharacter("Right"); // Reset to default after jump
         }
      }

      jumpUp();
   }

   // Collision detection
   function myHitOther(my1, my2) {
      let left1 = parseInt(document.getElementById(my1).style.left);
      let right1 = left1 + parseInt(document.getElementById(my1).style.width);
      let top1 = parseInt(document.getElementById(my1).style.top);
      let bottom1 = top1 + parseInt(document.getElementById(my1).style.height);
      let left2 = parseInt(document.getElementById(my2).style.left);
      let right2 = left2 + parseInt(document.getElementById(my2).style.width);
      let top2 = parseInt(document.getElementById(my2).style.top);
      let bottom2 = top2 + parseInt(document.getElementById(my2).style.height);
      return (
         right1 >= left2 &&
         bottom1 >= top2 &&
         left1 <= right2 &&
         top1 <= bottom2
      );
   }

   function myCheckHit() {
      if (myHitOther("myImg01", "myImg02")) {
         alert('You lose! Click "space" to restart.');
         document.getElementById("myImg01").style.left = "20px";
         location = "https://fluent-ftw.github.io/game-dev-2024-andy/public/game-andy.html"; // Reload same level
      }
   }

   function myCheckWin() {
      if (myHitOther("myImg01", "myImg03")) {
         alert("You win!");
         document.getElementById("myImg01").style.left = "20px";
         location = "t2a13-keydown.html"; // Go to next level
      }
   }

   // Start the game loop
   gameLoop();
</script>
